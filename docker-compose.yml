services:
  postgres:
    image: postgres:16-alpine
    container_name: node_bot_postgres
    restart: unless-stopped
    env_file:
      - .env.prod
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-bot}
      POSTGRES_USER: ${POSTGRES_USER:-bot}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-bot}
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./seeds:/seeds:ro

  bot:
    build: .
    container_name: node_bot_app
    restart: unless-stopped
    env_file:
      - .env.prod
    environment:
      DATABASE_URL: postgres://bot:bot@postgres:5432/bot
    depends_on:
      - postgres

  # admin:
  #   build:
  #     context: .
  #     dockerfile: admin/Dockerfile
  #   container_name: node_bot_admin
  #   restart: unless-stopped
  #   ports:
  #     - "5173:5173"
  #   environment:
  #     DATABASE_URL: postgres://bot:bot@postgres:5432/bot
  #     TELEGRAM_BOT_TOKEN: ${BOT_TOKEN}
  #     ADMIN_COOKIE_SECRET: ${ADMIN_COOKIE_SECRET:-change-me}
  #     VITE_TG_BOT_USERNAME: ${VITE_TG_BOT_USERNAME}
  #   depends_on:
  #     - postgres

  ngrok:
    image: ngrok/ngrok:alpine
    container_name: node_bot_ngrok
    restart: unless-stopped
    depends_on:
      - bot
    environment:
      NGROK_AUTHTOKEN: ${NGROK_AUTHTOKEN}
      VITE_TG_BOT_USERNAME: cards030_bot
    volumes:
      - ./ngrok.yml:/etc/ngrok.yml:ro
    ports:
      - "4040:4040"
    command: start --all --config /etc/ngrok.yml --log=stdout

volumes:
  postgres_data:
